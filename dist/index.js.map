{"version":3,"file":"index.js","names":["max","align","methods","colorMethods","extend","configs","target","forEach","method","config","reduce","t","c","Set","Array","isArray","length","validateQuery","query","_query","contain","cover","flip","resize","rotate","scale","scaleToFit","color","special","merge","SchemaUtils","validate","options","item","resourceQuery","resource","useMethods","items","match","map","value","matchs","includes","push","replace","jimp","AUTO","RESIZE_NEAREST_NEIGHBOR","RESIZE_BILINEAR","RESIZE_BICUBIC","RESIZE_HERMITE","RESIZE_BEZIER","e","v","split","HORIZONTAL_ALIGN_LEFT","HORIZONTAL_ALIGN_CENTER","HORIZONTAL_ALIGN_RIGHT","VERTICAL_ALIGN_TOP","VERTICAL_ALIGN_MIDDLE","VERTICAL_ALIGN_BOTTOM","a","Object","assign","key","test","parseFloat","colorValue","colorValueItem","apply","params","moduleQuery","urlQuery","globalQuery","specialQuery","RegExp","indexOf","raw","content","meta","callback","async","image","create","args","exec","maxValue","maxType","actualValue","Math","min","mime","getMIME","data","getBufferAsync","err"],"sources":["../src/index.js"],"sourcesContent":["import SchemaUtils from 'schema-utils'\nimport jimp from 'jimp'\n\nimport options from './options.json'\n\nconst max = /^m(w|h)(\\d+)$/\nconst align = /(\\,?(left|center|right|top|middle|bottom))+/\nconst methods = ['resize', 'contain', 'cover', 'flip', 'rotate', 'scale', 'scaleToFit', 'color']\nconst colorMethods = ['lighten', 'brighten', 'darken', 'desaturate', 'saturate', 'greyscale', 'spin', 'hue', 'mix', 'tint', 'shade', 'xor', 'red', 'green', 'blue']\n\nfunction extend(...configs) {\n  const target = {};\n  [...methods, 'special', 'merge', 'methods'].forEach(method => {\n    const config = configs.reduce((t, c) => {\n      if (t == null) {\n        return c[method]\n      } else if (method === 'methods') {\n        return [...new Set([...t, ...c[method]])]\n      } else if (Array.isArray(t)) {\n        return t.length || !Array.isArray(c[method]) ? t : c[method]\n      } else if (typeof t !== 'undefined') {\n        return t\n      }\n    }, null)\n    if (config != null) target[method] = config\n  })\n  return target\n}\n\nfunction validateQuery(query) {\n  const _query = extend(query, {\n    contain: [],\n    cover: [],\n    flip: [],\n    resize: [],\n    rotate: [],\n    scale: [],\n    scaleToFit: [],\n    color: [],\n    special: [],\n    merge: true,\n    methods\n  })\n\n  SchemaUtils.validate(options, _query)\n\n  _query.special.forEach(item => {\n    item.options = validateQuery(item.options)\n  })\n\n  return _query\n}\n\nfunction resourceQuery(resource) {\n  const useMethods = []\n  const items = resource.match(/[?&]\\w+\\=[^&]+/g)?.map(value => {\n    const matchs = value.match(/(\\w+)\\=([^&]+)/)\n    if (methods.includes(matchs[1])) useMethods.push(matchs[1])\n    return {\n      [matchs[1]]: matchs[2]\n        .replace('auto', jimp.AUTO)\n\n        .replace('nearest', jimp.RESIZE_NEAREST_NEIGHBOR)\n        .replace('bilinear', jimp.RESIZE_BILINEAR)\n        .replace('bicubic', jimp.RESIZE_BICUBIC)\n        .replace('hermite', jimp.RESIZE_HERMITE)\n        .replace('bezier', jimp.RESIZE_BEZIER)\n\n        .replace(align, e => {\n          const v = e.split(',').map(v => {\n            switch (v) {\n              case 'left':\n                return jimp.HORIZONTAL_ALIGN_LEFT\n              case 'center':\n                return jimp.HORIZONTAL_ALIGN_CENTER\n              case 'right':\n                return jimp.HORIZONTAL_ALIGN_RIGHT\n              case 'top':\n                return jimp.VERTICAL_ALIGN_TOP\n              case 'middle':\n                return jimp.VERTICAL_ALIGN_MIDDLE\n              case 'bottom':\n                return jimp.VERTICAL_ALIGN_BOTTOM\n              default:\n                return null\n            }\n          }).reduce((t, a) => {\n            if (t == null) {\n              return a\n            } else if (a == null) {\n              return t\n            } else {\n              return t | a\n            }\n          }, null)\n          return v == null ? '' : `,${v}`\n        })\n    }\n  }) || []\n  const query = items.reduce((target, value) => Object.assign(target, value), {})\n\n  for (const key in query) {\n    let value = query[key]\n\n    if (/true|false/.test(value)) {\n      value = value === 'true'\n    } else {\n      value = value.split(',').map(v => {\n        if (/^\\-?\\d+$/.test(v)) {\n          return parseFloat(v)\n        } else if (/true|false/.test(v)) {\n          return v === 'true'\n        } else {\n          return v\n        }\n      })\n\n      const colorValue = []\n      let colorValueItem = null\n      value.forEach(v => {\n        if (colorMethods.includes(v)) {\n          colorValueItem && colorValue.push(colorValueItem)\n\n          colorValueItem = {\n            apply: v,\n            params: []\n          }\n        } else if (colorValueItem) {\n          colorValueItem.params.push(v)\n        }\n      })\n      colorValueItem && colorValue.push(colorValueItem)\n      if (colorValue.length) value = colorValue\n    }\n\n    query[key] = value\n  }\n\n  query.methods = [...new Set([...(query.methods || []), ...useMethods])]\n\n  return query\n}\n\nfunction moduleQuery(query, resource) {\n  const urlQuery = validateQuery(resourceQuery(resource))\n  if (!urlQuery.merge) return urlQuery\n\n  const globalQuery = validateQuery(query)\n  let specialQuery = validateQuery({})\n  globalQuery.special.forEach(item => {\n    if (\n      (item.test instanceof RegExp && item.test.test(resource)) ||\n      (typeof item.test === 'string' && ~resource.indexOf(item.test))\n    ) {\n      if (item.options.merge) {\n        specialQuery = extend(item.options, specialQuery)\n      } else {\n        specialQuery = item.options\n      }\n    }\n  })\n  if (!specialQuery.merge) return extend(urlQuery, specialQuery)\n\n  return extend(urlQuery, specialQuery, globalQuery)\n}\n\nexport const raw = true\n\nexport default async function (content, map, meta) {\n  const callback = this.async()\n  try {\n    const query = moduleQuery(this.query, this.resource)\n    const image = await jimp.create(content)\n\n    query.methods.forEach(method => {\n      if (!methods.includes(method)) return\n      if (!query[method].length) return\n\n      const args = query[method].map(v => {\n        if (max.test(v)) {\n          const match = max.exec(v)\n          const maxValue = parseFloat(match[2])\n          const maxType = match[1] === 'w' ? 'Width' : (match[1] === 'h' ? 'Height' : '')\n          if (!maxType) return maxValue\n          const actualValue = image[`get${maxType}`]()\n          return Math.min(maxValue, actualValue)\n        } else {\n          return v\n        }\n      })\n\n      if (method === 'color') {\n        image[method](args)\n      } else {\n        image[method](...args)\n      }\n    })\n\n    const mime = image.getMIME()\n    const data = await image.getBufferAsync(mime)\n    callback(null, data, map, meta)\n  } catch (err) {\n    callback(err, '', map, meta)\n  }\n}\n"],"mappings":"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"}